{% extends "base.html" %}
{% block content %}

<h1>Form Purchase Order</h1>

<!-- Pesan dinamis -->
<div id="alert" style="display:none; padding:10px; margin-bottom:15px;"></div>

<form id="formPO">

  <div style="display:flex; gap:20px;">
    <!-- Kiri -->
    <div style="flex:1;">
      <label>Nomor PO</label>
      <input type="text" name="id_po" id="id_po" readonly placeholder="Otomatis">

      <label>Tanggal Pesanan</label>
      <input type="date" name="tanggal_order" id="tanggal_order" readonly value="{{ tanggal_order }}">

      <label>Nama Pemesan</label>
      <input type="text" name="nama_pemesan" id="nama_pemesan" required placeholder="Nama pemesan">

      <label>Alamat Kirim</label>
      <textarea name="alamat_kirim" id="alamat_kirim" required
          placeholder="Alamat lengkap pengiriman"
          style="width:100%; min-height:60px; resize:none; padding:6px; box-sizing:border-box;"></textarea>
    </div>

    <!-- Kanan -->
    <div style="flex:1;">
      <label>Supplier</label>
      <select name="id_supplier" id="supplier" required>
        <option value="">Pilih Supplier</option>
        {% for s in supplier %}
        <option value="{{ s[0] }}">{{ s[1] }}</option>
        {% endfor %}
      </select>
      
      <label>Tanggal Kirim</label>
      <input type="date" name="tanggal_kirim" id="tanggal_kirim" required>
    </div>
  </div>

  <h3>Detail Barang</h3>

<table border="1" cellpadding="6" id="table-barang" style="width:100%;">
  <tr>
    <th style="width:40%;">Barang</th>
    <th style="width:10%;">Qty</th>
    <th style="width:15%;">Harga</th>
    <th style="width:15%;">Subtotal</th>
    <th style="width:20%;">Aksi</th>
  </tr>
</table>

<!-- Form input barang -->
<div style="display:flex; gap:10px; margin-top:5px; align-items:flex-start; flex-wrap:wrap;">
  <div style="flex:2.1; display:flex; flex-direction:column;">
    <select id="barang">
      <option value="">Pilih Barang</option>
    </select>
    <!-- Stok & spesifikasi -->
    <textarea id="stok_spek" readonly
        style="margin-top:5px; width:100%; min-height:40px; resize:none; padding:4px; box-sizing:border-box;"
        placeholder="Stok dan spesifikasi barang akan muncul di sini"></textarea>

        
  </div>
  <input type="number" id="qty" value="1" min="1" style="flex:0.5;">
  <input type="number" id="harga" readonly style="flex:0.7;">
  <input type="number" id="subtotal" readonly style="flex:0.7;">
  <button type="button" id="add-barang" style="flex:1;">Tambah Barang</button>
</div>



  <br>
  <button type="submit">Simpan PO</button>
</form>

<script>
const supplier = document.getElementById("supplier");
const barang = document.getElementById("barang");
const qty = document.getElementById("qty");
const harga = document.getElementById("harga");
const subtotal = document.getElementById("subtotal");
const table = document.getElementById("table-barang");
const addBtn = document.getElementById("add-barang");
const idPoInput = document.getElementById("id_po");
const alamat = document.getElementById("alamat_kirim");
const alertDiv = document.getElementById("alert");
const stokSpek = document.getElementById("stok_spek");

let barangList = [];

// Auto-resize textarea
alamat.addEventListener("input", () => {
    alamat.style.height = "auto";
    alamat.style.height = alamat.scrollHeight + "px";
});

// Generate nomor PO saat supplier dipilih
supplier.addEventListener('change', ()=>{
    const s = supplier.value;
    if(!s){ idPoInput.value=''; return; }
    const d = new Date(); 
    const yyyy=d.getFullYear(); 
    const mm=String(d.getMonth()+1).padStart(2,'0');
    idPoInput.value = `PO-${yyyy}${mm}-${s}-XXXX`;
});
supplier.addEventListener("change", () => {
  if(barangList.length > 0){
    showAlert("Tidak bisa ganti supplier setelah barang ditambahkan!", "error");
    supplier.value = supplier.dataset.lastValue || "";
    return;
  }
  supplier.dataset.lastValue = supplier.value;

  barang.innerHTML = "<option value=''>Loading...</option>";
  fetch(`/get_barang/${supplier.value}`)
    .then(res => res.json())
    .then(data => {
      barang.innerHTML = "<option value=''>Pilih Barang</option>";
      data.barang.forEach(b => {
        // Tambahkan data stok & spesifikasi di data attributes
        barang.innerHTML += `<option value="${b.id}" data-harga="${b.harga}" data-stok="${b.stok}" data-spek="${b.spek}">${b.nama}</option>`;
      });
    });
});

function setQtyError(isError){
    if(isError){
        qty.style.border = "2px solid #dc3545";
        qty.style.backgroundColor = "#f8d7da";
    } else {
        qty.style.border = "";
        qty.style.backgroundColor = "";
    }
}
// Update harga & subtotal
function updateHarga() {
    const opt = barang.selectedOptions[0];
  if (!opt) {
    harga.value = 0;
    subtotal.value = 0;
    stokSpek.value = "";
    setQtyError(false);
    addBtn.disabled = true;
    return;
  }

  const h = parseFloat(opt.dataset.harga);
  const stok = parseInt(opt.dataset.stok);
  const q = parseInt(qty.value);

  harga.value = h;
  subtotal.value = q * h;
  stokSpek.value = `Stok: ${stok}\nSpesifikasi:\n${opt.dataset.spek || "-"}`;

  if (q > stok) {
        setQtyError(true);
        addBtn.disabled = true;
        showAlert(`Qty melebihi stok! Maksimal ${stok}`, "error");
    } else {
        setQtyError(false);
        addBtn.disabled = false;
    }
   

  
    harga.value = opt ? opt.dataset.harga || 0 : 0;
    subtotal.value = qty.value * harga.value;
    
   // Tampilkan stok & spesifikasi
    if(opt){
        const stok = opt.dataset.stok || "-";
        const spek = opt.dataset.spek || "-";
        document.getElementById("stok_spek").value = `Stok: ${stok}\nSpesifikasi: ${spek}`;
    } else {
        document.getElementById("stok_spek").value = "";
    }
}
barang.addEventListener("change", updateHarga);
qty.addEventListener("input", updateHarga);

// Tambah barang ke tabel
addBtn.addEventListener("click", () => {
    const id = barang.value;
    const nama = barang.selectedOptions[0]?.text;
    const h = parseFloat(harga.value);
    const q = parseInt(qty.value);
    const sub = parseFloat(subtotal.value);

    if(!id) return showAlert("Pilih barang!", "error");
    if(barangList.some(b => b.id===id)) return showAlert("Barang sudah ditambahkan!", "error");

    barangList.push({id,nama,h,q,sub});

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${nama}<input type="hidden" name="id_barang_list" value="${id}"></td>
      <td>${q}<input type="hidden" name="qty_list" value="${q}"></td>
      <td>${h}</td>
      <td>${sub}</td>
      <td><button type="button" class="hapus">Hapus</button></td>
    `;
    table.appendChild(tr);
    tr.querySelector(".hapus").addEventListener("click", ()=>{
        barangList = barangList.filter(b=>b.id!==id);
        tr.remove();
    });

    barang.value=""; qty.value=1; harga.value=0; subtotal.value=0;
});

// Show alert dinamis
function showAlert(msg, type="success"){
    alertDiv.style.display="block";
    alertDiv.style.backgroundColor = type==="error"?"#f8d7da":"#d4edda";
    alertDiv.style.color = type==="error"?"#721c24":"#155724";
    alertDiv.style.border = type==="error"?"1px solid #f5c6cb":"1px solid #c3e6cb";
    alertDiv.innerText = msg;
    setTimeout(()=>alertDiv.style.display="none", 5500);
}

// Submit via AJAX
document.getElementById("formPO").addEventListener("submit", e=>{
    e.preventDefault();

    if(barangList.length===0) return showAlert("Harap tambahkan minimal 1 barang!", "error");

    const formData = new FormData();
    formData.append("id_supplier", supplier.value);
    formData.append("tanggal_kirim", document.getElementById("tanggal_kirim").value);
    formData.append("nama_pemesan", document.getElementById("nama_pemesan").value);
    formData.append("alamat_kirim", alamat.value);

    barangList.forEach(b=>{
        formData.append("id_barang_list", b.id);
        formData.append("qty_list", b.q);
    });

    fetch("/simpan_po_ajax", {method:"POST", body:formData})
      .then(res=>res.json())
      .then(data=>{
        if(data.status==="error") showAlert(data.message, "error");
        else{
            showAlert("PO berhasil disimpan!","success");
            barangList=[]; 
            table.querySelectorAll("tr:not(:first-child)").forEach(tr=>tr.remove());
        }
      });
});
// Load barang berdasarkan supplier


// Update harga, subtotal, stok & spesifikasi

</script>
{% endblock %}
